# Travis CI configuration file
sudo: false
language: cpp
compiler:
  #- clang
  - gcc

addons:
  apt:
    packages:
    - protobuf-compiler
    
# blacklist
branches:
  except:
    - experimental
    - /^appveyor.*$/
    
env:
  global:
    # Dependencies
    - DEPS_DIR="`readlink -f $TRAVIS_BUILD_DIR/..`"
    - CONDA_ENV=test-environment
    - CONDA_ENV_PREFIX=$HOME/miniconda/envs/$CONDA_ENV
    # since we've set language to cpp we have to define python vars ourselves
    - TRAVIS_PYTHON_VERSION="2.7"
    - WITH_COVERAGE=ON

before_install:  
  - which python
  - python --version
  
  # Setup anaconda for python bindings
  - echo "Python $TRAVIS_PYTHON_VERSION"
  # CREDIT: https://github.com/SmokinCaterpillar/pypet/blob/master/.travis.yml
  - |
    if [[ $TRAVIS_PYTHON_VERSION == 2.* ]]; then
      travis_retry wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      travis_retry wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  # miniconda is not always updated with conda
  - conda update -q conda
  # Useful for debugging any issues with conda
  - conda info -a
  - conda create -q -n $CONDA_ENV python=$TRAVIS_PYTHON_VERSION pip numpy scipy nose mock h5py opencv PIL protobuf
  - source activate $CONDA_ENV
  
  # For mocking caffe
  - mv $TRAVIS_BUILD_DIR/caffe_mock.py $TRAVIS_BUILD_DIR/caffe.py
  # Download caffe protobuf message definitions
  - travis_retry wget -P $TRAVIS_BUILD_DIR https://raw.githubusercontent.com/BVLC/caffe/master/src/caffe/proto/caffe.proto
  - travis_retry wget -P $TRAVIS_BUILD_DIR/.. https://github.com/google/protobuf/releases/download/v2.6.1/protobuf-2.6.1.tar.gz
  
install:
  - echo "Installing Coveralls if coverage:"
  - if [[ $WITH_COVERAGE == ON ]]; then travis_retry pip install coveralls; fi
  - travis_retry pip install lmdb 
  - export LD_LIBRARY_PATH="$CONDA_ENV_PREFIX/lib:$LD_LIBRARY_PATH"
  - export C_INCLUDE_PATH="$CONDA_ENV_PREFIX/include:$C_INCLUDE_PATH"
  - export CPLUS_INCLUDE_PATH="$CONDA_ENV_PREFIX/include:$CPLUS_INCLUDE_PATH"
  # list installed python packages
  #- pip freeze
  - protoc -I=$TRAVIS_BUILD_DIR/ --python_out=$TRAVIS_BUILD_DIR/ $TRAVIS_BUILD_DIR/caffe.proto
  - ls $TRAVIS_BUILD_DIR
  
script:
  - nosetests --with-coverage --logging-level=INFO
  - ls -a
  
after_success:
  # report test coverage
  - coveralls --verbose

